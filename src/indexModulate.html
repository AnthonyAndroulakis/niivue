<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Modulation</title>
    <link rel="stylesheet" href="niivue.css">
  </head>
  <body>
    <noscript>niivue requires JavaScript.</noscript>
    <header>
        <label for="mode">Display:</label>
        <select name="mode" id="mode">
          <option>func</option>
          <option selected>tstat</option>
          <option>cope</option>
          <option>modulate</option>
        </select>
        <label for="slide">	&nbsp; tThresh</label>
        <input type="range" min="0" max="50" value="30" class="slider" id="slide">
        <label for="slide2">	&nbsp; Outline</label>
        <input type="range" min="0" max="4" value="1" class="slider" id="slide2">
    </header>
    <main>
      <canvas id="gl1"></canvas>
    </main>
    <footer id="location">
      &nbsp;
    </footer>
    <script type="module" async>
      import { Niivue } from './niivue.js'
      import {NVImage} from './nvimage.js'
      import {NVMesh} from './nvmesh.js'
      var slider = document.getElementById("slide");
      slider.oninput = function() {
        nv1.volumes[1].cal_min = 0.1 * this.value;
        nv1.updateGLVolume();
      }
      var slider2 = document.getElementById("slide2");
      slider2.oninput = function() {
        nv1.overlayOutlineWidth = 0.25  * this.value;
        nv1.updateGLVolume();
      }
      function handleLocationChange(data){ 
        function flt2str(flt, decimals = 0) {
          return flt.toFixed(decimals)
        }
        let str = "";
        for (let i = 0; i < data.values.length; i++)
            str += '  '+ flt2str(data.values[i].value, 3)
        document.getElementById('location').innerHTML = '&nbsp;&nbsp;'+flt2str(data.mm[0])+'×'+flt2str(data.mm[1])+'×'+flt2str(data.mm[2])+'='+str
      }
      var volumeList1 = [
        {
         url: "../demos/images/mean_func.nii.gz",
         opacity: 1,
         colorMap: "gray",
        },
        {
          url: "../demos/images/tstat1.nii.gz",
          opacity: 1,
          colorMap: "warm",
          cal_min: 1,
          cal_max: 5,
        },
        {
          url: "../demos/images/cope1.nii.gz",
          colorMap: "winter",
          opacity: 0,
          cal_min: 0.0,
          cal_max: 100,
        },
      ]
      var nv1 = new Niivue({
       backColor: [1, 1, 1, 1],
       onLocationChange:handleLocationChange
      })
      nv1.attachTo('gl1')
      nv1.overlayOutlineWidth = 0.25
      await nv1.loadVolumes(volumeList1)
      nv1.opts.isColorbar = true;
      nv1.setInterpolation(true);
      nv1.scene.crosshairPos = [0.55,0.5,0.8];
      nv1.setSliceType(nv1.sliceTypeMultiplanar)
      var drop = document.getElementById("mode")
      drop.onchange = function() {
        let mode = document.getElementById("mode").selectedIndex
        //for (let i = 1; i < 3; i++)
        nv1.setOpacity(0, 1.0) //background opaque
        nv1.setOpacity(1, 0.0) //hide tstat
        nv1.setOpacity(2, 0.0) //hide cope
        nv1.setOpacity(Math.min(2, mode), 1.0)
        console.log('mode',mode);
        if (mode === 3) 
          nv1.setModulationImage(nv1.volumes[2].id, nv1.volumes[1].id)
        else
          nv1.setModulationImage(nv1.volumes[2].id, null)
      }
    </script>
  </body>
</html>