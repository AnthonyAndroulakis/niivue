<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>NiiVue</title>
    <link rel="stylesheet" href="niivue.css" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  </head>
  <body>
    <noscript>
      <strong>niivue requires JavaScript.</strong>
    </noscript>
    <header>
      <select id="sliceDrop">
        <option value="0">Axial</option>
        <option value="1">Coronal</option>
        <option value="2">Sagittal</option>
        <option value="4">Render</option>
        <option value="3" selected>A+C+S+R</option>
      </select>
      <button id="saveBtn">save volume</button>
    </header>
    <main id="canvas-container">
      <canvas id="gl1"></canvas>
    </main>
    <footer>
    <footer id="intensity">&nbsp;</footer>
    </footer>
    <script type="module" async>
      import {
        iwm2mesh,
        iwi2nii
      } from "./itk2cbor.js"
      import {
        Niivue,
        NVImage,
        NVMesh,
        NVMeshLoaders,
        NVMeshUtilities,
        SHOW_RENDER
      } from "./niivue/index.ts"
      sliceDrop.onchange = function () {
        let st = parseInt(this.value);
        nv1.setSliceType(st);
      }
      function handleIntensityChange(data) {
        document.getElementById("intensity").innerHTML =
          "&nbsp;&nbsp;" + data.string;
      }
      saveBtn.onclick = function () {
        nv1.saveImage({ filename: 'test.nii', isSaveDrawing: false, volumeByIndex: 0})
      }
      let defaults = {
        backColor: [0, 0, 0, 1],
        show3Dcrosshair: true,
        loglevel: 'debug',
        onLocationChange: handleIntensityChange
      }
      var nv1 = new Niivue(defaults)
      nv1.attachToCanvas(gl1)
      async function loadBinaryFile(url) {
          try {
              const response = await fetch(url)
              if (!response.ok) {
                  throw new Error(`Failed to load file: ${response.statusText}`)
              }
              return await response.arrayBuffer()
          } catch (error) {
              console.error('Error loading binary file:', error)
          }
      }
      async function processIWM(url) {
        const arrayBuffer = await loadBinaryFile(url)
        let mesh = iwm2mesh(arrayBuffer)
        const mz3 = NVMeshUtilities.createMZ3(mesh.positions, mesh.indices, false)
        await nv1.loadFromArrayBuffer(mz3, 'test.mz3')
      }
      async function processIWI(url) {
        const arrayBuffer = await loadBinaryFile(url)
        let nii = iwi2nii(arrayBuffer)
        await nv1.loadVolumes([{ url: nii, name: 'test.nii' }]);
      }
      processIWM('./cow.iwm.cbor')
      processIWI('./fslmean.iwi.cbor')
    </script>
  </body>
</html>
