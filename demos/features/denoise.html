<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>NiiVue</title>
    <link rel="stylesheet" href="niivue.css" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
<style>
dialog {
  z-index: 10;
  margin-top: 10px;
  border: solid;
  border-radius: 1rem;
}
</style>
  </head>
  <body>
    <noscript>
      <strong>niivue requires JavaScript.</strong>
    </noscript>
    <header>
      <button id="denoiseBtn">Denoise</button>
      <label for="darkCheck">ClipDark</label>
      <input type="checkbox" id="darkCheck" checked />
    </header>
    <main id="canvas-container">
      <canvas id="gl1"></canvas>
    </main>
    <footer id="intensity">&nbsp;</footer>
    <dialog id="denoiseDialog">
      <form method="dialog">
        <p>
          <label>
            Reduce dark noise:
            <select id="otsuSelect">
              <option>Very Heavy</option>
              <option>Heavy</option>
              <option>Medium</option>
              <option>Light</option>
              <option selected>Very Light</option>
              <option>None</option>
            </select>
          </label>
        </p>
        <div>
          <button type="button" id="saveBtn">Save</button>
          <button id="cancelBtn" formmethod="dialog">Cancel</button>
          <button autofocus id="applyBtn" value="default">Apply</button>
        </div>
      </form>
    </dialog>
    <script type="module" async>
      import * as niivue from "../dist/index.js"
      denoiseBtn.onclick = function () {
        otsuSelect.onchange()
        denoiseDialog.show()
      }
      saveBtn.onclick = function () {
        nv1.volumes[0].saveToDisk("denoised.nii")
      }
      cancelBtn.onclick = function () {
        nv1.volumes[0].img = imgRaw.slice()
        nv1.updateGLVolume()
      }
      otsuSelect.onchange = function () {
        const level = otsuSelect.selectedIndex + 1
        //reload original image, so user can compare different Otsu levels
        nv1.volumes[0].img = imgRaw.slice()
        if (level > 5) { //no denoising = raw image
          nv1.updateGLVolume()
          return
        }
        let otsu = 2
        if (level === 5 || level === 1) {
          otsu = 4
        }
        if (level === 4 || level === 2) {
          otsu = 3
        }
        const thresholds = nv1.findOtsu(otsu)
        if (thresholds.length < 3) {
          return
        }
        let threshold = thresholds[0]
        if (level === 1) {
          threshold = thresholds[2]
        }
        if (level === 2) {
          threshold = thresholds[1]
        }
        const img = nv1.volumes[0].img
        const nvox = img.length
        const mn = nv1.volumes[0].global_min
        for (let v = 0; v < nvox; v++) {
          if (img[v] < threshold)
            img[v] = mn
        }
        nv1.updateGLVolume()
      }
      darkCheck.onchange = function () {
        nv1.isAlphaClipDark = this.checked
        nv1.updateGLVolume()
      }
      function handleIntensityChange(data) {
        document.getElementById("intensity").innerHTML =
          "&nbsp;&nbsp;" + data.string
      }
      var volumeList1 = [{ url: "../images/otsu.nii.gz"}]
      let defaults = {
        backColor: [0.9, 0.9, 1, 1],
        show3Dcrosshair: true,
        onLocationChange: handleIntensityChange,
      }
      let imgRaw
      var nv1 = new niivue.Niivue(defaults)
      nv1.attachToCanvas(gl1)
      nv1.onImageLoaded = (volume) => {
        imgRaw = nv1.volumes[0].img.slice()
      }
      nv1.opts.dragMode = nv1.dragModes.pan
      nv1.opts.multiplanarForceRender = true
      nv1.opts.yoke3Dto2DZoom = true
      nv1.setInterpolation(true)
      await nv1.loadVolumes(volumeList1)
      nv1.setClipPlane([0.2, 0, 120])
      darkCheck.onchange()
    </script>
  </body>
</html>